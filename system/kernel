local _build = 33
local args = { ... }

_running = true

local modules = {
    ["Directory"] = false,
    ["String"] = false,
	["Screen"] = false,
    ["Internet"] = false,
    ["Drawing"] = false
}

function load_module(module_name)
	if not modules[module_name] then
		System.debug(0, "Loading module " .. module_name)
		_OENV.loadfile("/system/modules/" .. module_name .. ".mm.lua", _OENV.getfenv())()
		modules[module_name] = true
	else
		System.debug(2,"Module " .. module_name .. " already loaded!")
	end
end

function unload_module(module_name)
	if modules[module_name] then
		System.debug(0, "Unloading module " .. module_name)
		modules[module_name] = false
		module_name = nil
	else
		System.debug(2, "Module " .. module_name .. " was not loaded!")
	end

end

function kmain( ... )

	--[[ Load modules ]]--
	for k, _ in _OENV.pairs(modules) do
		load_module(k)
	end

	System.debug(0, "Loading MaCCOS kernel [build " .. _build .. "]")

	--[[ Load System ]]--
    _OENV.loadfile( ... , _OENV.getfenv())()

	--[[ System start() ]]--
	local state = start()

	--[[ Main System loop ]]--
	if state == 0 then
		while _running do
			loop()
		end
	else
		System.debug(3, "Error code: " .. _OENV.tostring(state))
	end

	--[[ System stop ]]--
	stop()
end

local ok, err = _OENV.pcall(function() kmain(_OENV.unpack(args)) end)
if not ok then

    Logger.start()
	System.debug(3, "\nSomething went wrong :(")
	System.debug(3, err)
	Logger.stop()

end
