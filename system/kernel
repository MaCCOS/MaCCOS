local _build = 22
local args = { ... }

local _running = true

modules = {
	"/system/modules/Directory.mm.lua",
	"/system/modules/Logger.mm.lua",
	"/system/modules/Screen.mm.lua",
	"/system/modules/String.mm.lua",
	"/system/modules/System.mm.lua"
}

function load_module(module_name)
	dofile(module_name)
end

function kmain( ... )
	for i = 1, #modules do
		load_module(modules[i])
	end

	logfile = Logger.start()
	Logger.log("Loading MaCCOS kernel [build " .. _build .. "]")

	dofile("/system/system.lua")
	dofile("/system/init")

	state = start()
	if state == 0 then
		while _running do
			loop()
		end
	else
		printError("Error code: " .. state)
	end
	stop()
	Logger.stop(logfile)
end

local ok, err = pcall(function() kmain(unpack(args)) end)
if not ok then
	load_module(modules[i])
	Logger.log("\nSomething went wrong :(")
	Logger.log(err)
	Logger.stop()
end
